# Документация по функции "Прогноз сбыта"

## Описание функции

Функция "Прогноз сбыта" добавлена в главную игровую сцену и предоставляет интерактивный анализ потенциального спроса на мед для двух различных брендов с возможностью настройки параметров через ползунки.

## Расположение

- **Кнопка**: Добавлена в `templates/game_main.html` ниже кнопки "Авито"
- **JavaScript**: Функции в `static/js/sales-forecast.js`
- **CSS**: Стили в `static/css/sales-forecast.css`
- **Подключение**: Файлы подключены в `templates/base.html`

## Функциональность

### Интерфейс

1. **Кнопка "Прогноз сбыта"**
   - Расположена в правой панели управления игрой
   - Стиль: `btn btn-info` (синий цвет)
   - При нажатии открывает широкое модальное окно

2. **Модальное окно**
   - Ширина: 90% от экрана (адаптивное)
   - Две вкладки для разных брендов меда
   - Вкладки переключаются без перезагрузки страницы

### График №1: "Волчий мед"

**Заголовок**: "Бренд 'Волчий мед'"
**Слоган**: "Собран там, где волки ходить боятся"

**Базовые данные спроса по месяцам**:
- Апрель: 50 кг
- Май: 30 кг  
- Июнь: 20 кг
- Июль: 10 кг
- Август: 30 кг
- Сентябрь: 40 кг
- Октябрь: 50 кг
- Ноябрь: 60 кг
- Декабрь: 70 кг
- Январь: 30 кг
- Февраль: 30 кг
- Март: 30 кг

**Ползунки управления**:

1. **Цена меда**
   - Диапазон: 300-5000 руб.
   - Начальное значение: 600 руб.
   - Влияет на пересчет графика спроса

2. **Уровень бренда**
   - Диапазон: -10 до 100
   - Начальное значение: 30
   - Влияет на пересчет графика спроса

3. **Количество ульев**
   - Диапазон: 4-30
   - Начальное значение: 4
   - Влияет на расчет "Меда собрано" и "Заработано за год"

**Алгоритм пересчета графика**:
- При цене 600 руб. (базовая) используются начальные значения
- При уменьшении цены до 300: значения растут `<уровень бренда> / 30`
- При увеличении до критического значения (`<уровень бренда> * 30`): значения падают до `начальные значения * <уровень бренда> * 0.57`
- После критического значения: значения падают до `начальные значения * <уровень бренда> * 0.17`

**Расчет итоговых показателей**:
- **Меда собрано**: `<количество ульев> * 20` кг
- **Заработано за год**: 
  - Если сумма спроса > количество ульев * 20: `<количество ульев> * "Цена меда" - <количество ульев>*2000`
  - Иначе: `<сумма значений графика спроса> * "Цена меда" - <количество ульев>*2000`

### График №2: "Деснянский мед"

**Заголовок**: "Бренд 'Деснянский мед'"
**Слоган**: "Собран в экологически чистых местах"

**Базовые данные спроса по месяцам**:
- Апрель: 100 кг
- Май: 60 кг
- Июнь: 80 кг
- Июль: 90 кг
- Август: 60 кг
- Сентябрь: 40 кг
- Октябрь: 60 кг
- Ноябрь: 80 кг
- Декабрь: 120 кг
- Январь: 60 кг
- Февраль: 80 кг
- Март: 80 кг

**Ползунки управления**:

1. **Цена меда**
   - Диапазон: 100-1000 руб.
   - Начальное значение: 200 руб.
   - Влияет на пересчет графика спроса

2. **Уровень бренда**
   - Диапазон: -30 до 30
   - Начальное значение: 0
   - Влияет на пересчет графика спроса

3. **Количество ульев**
   - Диапазон: 4-30
   - Начальное значение: 4
   - Влияет на расчет "Меда собрано" и "Заработано за год"

**Алгоритм пересчета графика**:
- При цене 200 руб. (базовая) используются начальные значения
- При уменьшении цены до 100: значения растут `<уровень бренда> / 30`
- При увеличении до критического значения (`<уровень бренда> * 10`): значения падают до `начальные значения * <уровень бренда> * 0.37`
- После критического значения: значения падают до `начальные значения * <уровень бренда> * 0.17`

**Расчет итоговых показателей**:
- **Меда собрано**: `<количество ульев> * 60` кг
- **Заработано за год**:
  - Если сумма спроса > количество ульев * 60: `<количество ульев> * "Цена меда" - <количество ульев>*2000 - <количество ульев> * 30*50`
  - Иначе: `<сумма значений графика спроса> * "Цена меда" - <количество ульев>*2000 - <количество ульев> * 30*50`

## Техническая реализация

### Архитектура

Код прогноза сбыта вынесен в отдельные файлы для лучшей организации и изоляции функциональности:

#### JavaScript файл (`static/js/sales-forecast.js`)
Все функции прогноза сбыта находятся в отдельном файле:
1. **`showSalesForecast()`** - Основная функция открытия модального окна
2. **`getSalesForecastContent()`** - Генерация HTML контента
3. **`switchForecastTab()`** - Переключение между вкладками
4. **`createSalesForecastCharts()`** - Создание обоих графиков
5. **`createWolfHoneyChart()`** - Создание графика "Волчьего меда"
6. **`createDesnyanskyHoneyChart()`** - Создание графика "Деснянского меда"
7. **`recalculateWolfHoneyData()`** - Пересчет данных для "Волчьего меда"
8. **`recalculateDesnyanskyHoneyData()`** - Пересчет данных для "Деснянского меда"
9. **`updateWolfHoneySummary()`** - Обновление сводных данных "Волчьего меда"
10. **`updateDesnyanskyHoneySummary()`** - Обновление сводных данных "Деснянского меда"
11. **`setupForecastControls()`** - Настройка обработчиков событий ползунков

Функция `showSalesForecast()` экспортирована в глобальную область видимости для доступности из HTML onclick обработчика.

#### CSS файл (`static/css/sales-forecast.css`)
Все стили прогноза сбыта находятся в отдельном файле:
- **Вкладки**: Стили для переключения между брендами
- **Графики**: Адаптивное расположение графиков и панелей сводных данных
- **Ползунки**: Стилизованные элементы управления с цветовыми акцентами
- **Адаптивность**: Поддержка мобильных устройств
- **Цветовое кодирование**: Разные цвета для каждого бренда

#### Подключение в HTML (`templates/base.html`)
Файлы подключены в базовый шаблон:
```html
<link rel="stylesheet" href="{{ url_for('static', filename='css/sales-forecast.css') }}">
<script src="{{ url_for('static', filename='js/sales-forecast.js') }}"></script>
```

### Библиотеки

- **Chart.js**: Используется для создания интерактивных графиков
- **Bootstrap**: Используется для модальных окон и базовых стилей

## Особенности

1. **Интерактивность**: Все ползунки работают в реальном времени и пересчитывают графики
2. **Адаптивность**: Интерфейс корректно отображается на всех устройствах
3. **Визуализация**: Используются цветовые акценты для различения брендов
4. **Производительность**: Графики пересоздаются только при изменении активной вкладки
5. **Пользовательский опыт**: Плавные переходы и интуитивный интерфейс

## Тестирование

Функциональность тестируется путем:
1. Нажатия кнопки "Прогноз сбыта" в главной игровой сцене
2. Переключения между вкладками брендов
3. Перемещения ползунков и наблюдения за изменением графиков
4. Проверки корректности расчетов итоговых показателей
5. Тестирования на различных размерах экрана

## Изменения в версии v.0.0.1 [KodaCode] [37]

### Исправление размеров модального окна "Прогноз сбыта" (v.0.0.1 [KodaCode] [38])

**Проблема**: Ползунки бренда и количества ульев под графиком №1 не были видны из-за недостаточного размера модального окна. Секция `<div class="controls-section">` не помещалась в окно.

**Первое решение (v.0.0.1 [KodaCode] [37])**: Кардинально увеличены размеры модального окна и оптимизирована компоновка элементов.

**Проблема после первого решения**: После чрезмерного уменьшения размеров элементов, они стали невидимыми.

**Финальное решение**: Найден баланс между размером модального окна и видимостью всех элементов:

#### 1. Оптимальные размеры модального окна
- **Ширина**: 95vw (стабильная и проверенная)
- **Высота**: 95vh (достаточная для всех элементов)
- **Отступы**: 20px от краев экрана
- **Медиа-запрос**: для экранов 1400px+ ширина 1200px

#### 2. Оптимальные размеры графиков
- **Высота canvas**: 320px (хорошая видимость графиков)
- **Максимальная ширина canvas**: 900px
- **Минимальная ширина canvas**: 650px

#### 3. Оптимальные размеры секции управления
- **Gap**: 15px
- **Margin-top**: 20px
- **Padding**: 20px
- **Border-radius**: 8px
- **Фон**: светло-серый (#fafafa)

#### 4. Оптимальные размеры элементов управления
- **Gap между элементами**: 15px
- **Padding**: 12px
- **Border-radius**: 8px
- **Box-shadow**: нормальная интенсивность

#### 5. Оптимальные размеры панели сводных данных
- **Min-width**: 200px
- **Padding**: 15px
- **Border-radius**: 8px

#### 6. Оптимальные размеры контейнера графиков
- **Gap**: 20px
- **Margin-bottom**: 20px

#### 7. Оптимальные размеры заголовков брендов
- **Margin-bottom**: 20px
- **Padding**: 15px
- **Border-radius**: 8px

**Финальный результат**: 
- ✅ Модальное окно имеет оптимальные размеры (95vw × 95vh)
- ✅ Все элементы управления полностью видимы и функциональны
- ✅ Графики хорошо читаемы и информативны
- ✅ Сохранена функциональность и удобство использования
- ✅ Хорошая адаптация под различные размеры экрана

### Добавление вертикальной прокрутки (v.0.0.1 [KodaCode] [40])

**Проблема**: При большом количестве контента в модальном окне "Прогноз сбыта" не было удобной прокрутки содержимого.

**Решение**: Добавлена настраиваемая вертикальная прокрутка с улучшенным дизайном:

#### 1. Основные стили прокрутки
- **Overflow-y**: добавлен `auto` в общую секцию `.modal .modal-body`
- **Максимальная высота**: установлена на 90vh для модального окна прогноза сбыта
- **Отступы**: уменьшены до 15px для экономии места

#### 2. Улучшенная полоса прокрутки
- **Firefox**: `scrollbar-width: thin` и `scrollbar-color: #007bff #f1f1f1`
- **Webkit браузеры**: кастомные стили для полосы прокрутки
  - Ширина: 8px
  - Цвет фона: #f1f1f1 с радиусом 4px
  - Цвет ползунка: #007bff с радиусом 4px
  - Hover эффект: изменение цвета на #0056b3

#### 3. Адаптивность
- **Мобильные устройства**: максимальная высота 85vh и уменьшенные отступы
- **Позиционирование**: добавлен `relative` для правильного позиционирования

**Результат**:
- ✅ Плавная и удобная вертикальная прокрутка содержимого
- ✅ Красивая настраиваемая полоса прокрутки
- ✅ Работает во всех современных браузерах
- ✅ Адаптирована под мобильные устройства
- ✅ Улучшен пользовательский опыт взаимодействия

## Версия

v.0.0.1 [KodaCode] [39]

---

**Автор**: KodaCode  
**Дата**: Декабрь 2024  
**Статус**: Реализовано, исправлено, оптимизировано и стабилизировано