{% extends "base.html" %}

{% block title %}Выбор места пасеки - Пчелка Майя{% endblock %}

{% block content %}
<div class="map-interface">
    <div class="map-container">
        <div id="map" class="map-display">
            <div class="map-placeholder">
                <h3>Яндекс.Карты</h3>
                <p>Выберите место для расположения вашей пасеки</p>
                <p><small>(В полной версии здесь будет интерактивная карта)</small></p>
                
                <!-- Симуляция карты с координатами -->
                <div class="map-simulation">
                    <div class="map-grid">
                        {% for i in range(10) %}
                        <div class="map-cell" onclick="selectMapLocation(55.0 + i * 0.1 ,  37.0 + i * 0.1 , 'Московская область')">
                            <div class="cell-content"></div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="map-legend">
                        <div class="legend-item">
                            <div class="legend-color good"></div>
                            <span>Хорошие места для пасеки</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color average"></div>
                            <span>Средние места</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color poor"></div>
                            <span>Нежелательные места</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="location-info">
            <h4>Информация о местности</h4>
            <div id="selected-location" class="location-details">
                <p>Выберите место на карте для получения информации</p>
            </div>
        </div>
    </div>
    
    <div class="map-controls">
        <button class="btn btn-primary" id="select-location-btn" onclick="confirmLocation()" disabled>
            Выбрать это место
        </button>
        
        <button class="btn btn-secondary" onclick="window.location.href='/auth/index'">
            Назад
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedLocation = null;

function selectMapLocation(latitude, longitude, city) {
    selectedLocation = { latitude, longitude, city };
    
    // Обновляем интерфейс
    updateLocationDisplay(latitude, longitude, city);
    
    // Включаем кнопку выбора
    document.getElementById('select-location-btn').disabled = false;
    
    // Подсвечиваем выбранную ячейку
    document.querySelectorAll('.map-cell').forEach(cell => {
        cell.classList.remove('selected');
    });
    event.target.closest('.map-cell').classList.add('selected');
}

function updateLocationDisplay(latitude, longitude, city) {
    const locationDiv = document.getElementById('selected-location');
    
    // Симулируем получение информации о местности
    const nectarQuality = getNectarQuality(latitude, longitude);
    const climateInfo = getClimateInfo(latitude, longitude);
    
    locationDiv.innerHTML = `
        <div class="location-summary">
            <h5>${city}</h5>
            <p><strong>Координаты:</strong> ${latitude.toFixed(4)}, ${longitude.toFixed(4)}</p>
        </div>
        
        <div class="location-stats">
            <div class="stat-item">
                <span class="stat-label">Качество взятка:</span>
                <span class="stat-value nectar-${nectarQuality.level}">${nectarQuality.description}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Климат:</span>
                <span class="stat-value">${climateInfo.type}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Средняя температура:</span>
                <span class="stat-value">${climateInfo.temperature}°C</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Основные медоносы:</span>
                <span class="stat-value">${nectarQuality.plants.join(', ')}</span>
            </div>
        </div>
        
        <div class="location-recommendations">
            <h6>Рекомендации:</h6>
            <ul>
                ${nectarQuality.recommendations.map(rec => `<li>${rec}</li>`).join('')}
            </ul>
        </div>
    `;
}

function getNectarQuality(latitude, longitude) {
    // Симуляция определения качества местности для пчеловодства
    const qualities = [
        {
            level: 'excellent',
            description: 'Отличное',
            plants: ['Липа', 'Акация', 'Гречиха', 'Подсолнух'],
            recommendations: [
                'Идеальное место для размещения пасеки',
                'Высокая продуктивность взятка',
                'Разнообразие медоносов'
            ]
        },
        {
            level: 'good',
            description: 'Хорошее',
            plants: ['Ива', 'Клен', 'Малина', 'Яблоня'],
            recommendations: [
                'Хорошие условия для пчеловодства',
                'Стабильный взяток в течение сезона'
            ]
        },
        {
            level: 'average',
            description: 'Среднее',
            plants: ['Одуванчик', 'Клевер', 'Луговые травы'],
            recommendations: [
                'Приемлемые условия',
                'Требует дополнительного внимания к подкормке'
            ]
        },
        {
            level: 'poor',
            description: 'Слабое',
            plants: ['Редкие дикорастущие'],
            recommendations: [
                'Не рекомендуется для коммерческого пчеловодства',
                'Потребуется интенсивная подкормка пчел'
            ]
        }
    ];
    
    // Простая логика определения качества на основе координат
    const hash = Math.abs(Math.sin(latitude) * Math.cos(longitude) * 1000);
    return qualities[Math.floor(hash) % qualities.length];
}

function getClimateInfo(latitude, longitude) {
    // Симуляция климатической информации
    const climates = [
        { type: 'Умеренно-континентальный', temperature: 15 + Math.random() * 10 },
        { type: 'Континентальный', temperature: 12 + Math.random() * 15 },
        { type: 'Умеренно-морской', temperature: 18 + Math.random() * 8 }
    ];
    
    return climates[Math.floor(Math.random() * climates.length)];
}

function confirmLocation() {
    if (selectedLocation) {
        selectLocation(selectedLocation.latitude, selectedLocation.longitude, selectedLocation.city);
    }
}

// Инициализация карты (в полной версии здесь была бы интеграция с Яндекс.Картами)
document.addEventListener('DOMContentLoaded', function() {
    // В реальном приложении здесь была бы инициализация Яндекс.Карт
    console.log('Карта инициализирована');
    
    // Симулируем определение текущего местоположения
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            // Можно автоматически выбрать ближайшую точку на карте
            console.log(`Текущие координаты: ${lat}, ${lon}`);
        });
    }
});
</script>

<style>
.map-interface {
    display: flex;
    flex-direction: column;
    height: 100%;
    gap: 20px;
    max-width: 100%;
    overflow-x: hidden;
}

.map-container {
    flex: 1;
    display: flex;
    gap: 20px;
    min-height: 400px;
}

.map-display {
    flex: 1;
    max-width: 400px;
    background: linear-gradient(135deg, #87CEEB 0%, #98FB98 100%);
    border: 3px solid #8B4513;
    border-radius: 15px;
    position: relative;
    overflow: hidden;
}

.map-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: #2F4F4F;
    text-align: center;
    padding: 20px;
}

.map-simulation {
    margin-top: 20px;
    width: 100%;
    max-width: 500px;
}

.map-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2px;
    background: #2F4F4F;
    padding: 2px;
    border-radius: 5px;
    margin-bottom: 15px;
    max-width: 100%;
}

.map-cell {
    aspect-ratio: 1;
    background: #90EE90;
    cursor: pointer;
    transition: all 0.3s ease;
    border-radius: 3px;
}

.map-cell:hover {
    background: #32CD32;
    transform: scale(1.1);
}

.map-cell.selected {
    background: #FFD700;
    box-shadow: 0 0 10px #FFD700;
}

.map-cell:nth-child(3n) {
    background: #ADFF2F;
}

.map-cell:nth-child(4n) {
    background: #DDA0DD;
}

.map-cell:nth-child(5n) {
    background: #F0E68C;
}

.map-legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
}

.legend-color {
    width: 15px;
    height: 15px;
    border-radius: 3px;
    border: 1px solid #2F4F4F;
}

.legend-color.good {
    background: #32CD32;
}

.legend-color.average {
    background: #ADFF2F;
}

.legend-color.poor {
    background: #DDA0DD;
}

.location-info {
    flex: 3;
    background: rgba(245, 230, 211, 0.9);
    border: 2px solid #8B4513;
    border-radius: 10px;
    padding: 20px;
    overflow-y: auto;
}

.location-summary {
    border-bottom: 2px solid #D2691E;
    padding-bottom: 15px;
    margin-bottom: 15px;
}

.location-summary h5 {
    color: #8B4513;
    margin-bottom: 10px;
    font-size: 18px;
}

.location-stats {
    margin-bottom: 20px;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding: 5px 0;
    border-bottom: 1px solid rgba(139, 69, 19, 0.2);
}

.stat-label {
    font-weight: 600;
    color: #2F4F4F;
}

.stat-value {
    color: #8B4513;
    font-weight: bold;
}

.nectar-excellent {
    color: #228B22;
}

.nectar-good {
    color: #32CD32;
}

.nectar-average {
    color: #DAA520;
}

.nectar-poor {
    color: #DC143C;
}

.location-recommendations {
    background: rgba(255,255,255,0.5);
    border: 1px solid #D2691E;
    border-radius: 8px;
    padding: 15px;
}

.location-recommendations h6 {
    color: #8B4513;
    margin-bottom: 10px;
}

.location-recommendations ul {
    padding-left: 20px;
    margin: 0;
}

.location-recommendations li {
    margin: 5px 0;
    color: #2F4F4F;
}

.map-controls {
    display: flex;
    gap: 15px;
    justify-content: center;
}

#select-location-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Адаптивность */
@media (max-width: 768px) {
    .map-container {
        flex-direction: column;
        gap: 15px;
    }
    
    .map-display {
        max-width: 100%;
        width: 100%;
    }
    
    .map-grid {
        grid-template-columns: repeat(4, 1fr);
        max-width: 280px;
        margin: 0 auto 15px;
    }
    
    .map-legend {
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }
    
    .location-info {
        max-height: 300px;
        width: 100%;
    }
    
    .map-controls {
        flex-direction: column;
        gap: 10px;
    }
    
    .map-controls .btn {
        width: 100%;
        margin: 0;
    }
    
    .map-interface {
        padding: 10px;
    }
    
    .map-placeholder {
        padding: 15px;
    }
}
</style>
{% endblock %}