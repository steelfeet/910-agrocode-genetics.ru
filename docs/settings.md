# Добавление кнопки "Выбрать место" с интеграцией Яндекс.Карт

## Описание изменений

Реализована функциональность выбора места расположения пасеки на странице настроек с использованием Яндекс.Карт. Пользователь может выбрать местоположение пасеки интерактивно на карте, что автоматически определит город и климатические условия.

## Реализованные функции

### 1. Кнопка "Выбрать место"
- Добавлена кнопка рядом с полем "Город" в форме настроек
- Кнопка оформлена в стиле input-group для лучшей интеграции с полем ввода
- При нажатии открывает модальное окно с картой

### 2. Модальное окно с Яндекс.Картами
- Модальное окно шириной 80% от основного экрана
- Заголовок: "Выбор места расположения пасеки"
- Полноэкранная карта с интерактивными элементами управления

### 3. Функциональность карты
- **Интерактивная карта**: пользователь может кликнуть по любому месту на карте
- **Перетаскиваемая метка**: зеленая метка, которую можно перетаскивать по карте
- **Поиск по адресу**: встроенный поиск Яндекс.Карт
- **Геолокация**: кнопка "Моё местоположение" для автоматического определения местоположения пользователя

### 4. Информационная панель
- Отображение координат выбранного места (широта и долгота)
- Полный адрес выбранного места
- Инструкции для пользователя

### 5. Автоматическое определение города
- При выборе места автоматически извлекается город из адреса
- Обновляется поле "Город" в форме настроек
- Автоматически обновляется предварительный просмотр климатических условий

### 6. Передача выбранного города в форму настроек
- При нажатии кнопки "Выбрать это место" в модальном окне
- Выбранный город автоматически передается в поле `<input type="text" id="city" name="city" class="form-control" value="None" readonly>`
- Реализована через функцию `confirmLocation()` с извлечением города из адреса
- Автоматическое обновление предварительного просмотра после передачи города

## Технические детали

### Подключение API Яндекс.Карт
```javascript
// Динамическая загрузка API при необходимости
const script = document.createElement('script');
script.src = 'https://api-maps.yandex.ru/2.1/?apikey=e6b34264-72ad-4e9b-9c46-548063340836&lang=ru_RU';
```

### Создание карты
```javascript
window.locationMap = new ymaps.Map('location-map', {
    center: [55.751244, 37.618423], // Москва по умолчанию
    zoom: 10
}, {
    searchControlProvider: 'yandex#search'
});
```

### Перетаскиваемая метка
```javascript
window.locationPlacemark = new ymaps.Placemark([55.751244, 37.618423], {
    iconContent: "Место для пасеки",
    hintContent: "Перетащите метку или кликните по карте"
}, {
    preset: 'islands#StretchyIcon',
    iconColor: '#00ff00',
    draggable: true
});
```

### Обработка событий
- **Клик по карте**: установка метки в место клика
- **Перетаскивание метки**: обновление координат и адреса
- **Геолокация**: определение текущего местоположения пользователя

### Передача выбранного города - техническая реализация

#### Алгоритм работы функции confirmLocation()
```javascript
function confirmLocation() {
    // 1. Валидация выбора места
    const lat = document.getElementById('selected-lat').textContent;
    const lng = document.getElementById('selected-lng').textContent;
    const address = document.getElementById('selected-address').textContent;
    
    if (lat === '-' || lng === '-') {
        alert('Пожалуйста, выберите место на карте.');
        return;
    }
    
    // 2. Извлечение города из адреса
    const city = extractCityFromAddress(address);
    
    // 3. Обновление поля города в форме
    document.getElementById('city').value = city;
    
    // 4. Обновление предварительного просмотра
    updatePreview();
    
    // 5. Закрытие модального окна
    closeModal();
}
```

#### Извлечение города из адреса
```javascript
function extractCityFromAddress(address) {
    // Разбиваем адрес на части по запятой
    const parts = address.split(',');
    // Берем первую часть как название города
    return parts[0].trim() || 'Неизвестный город';
}
```

#### Обработка различных форматов адресов
- **Российские адреса**: "Москва, Россия" → "Москва"
- **Региональные центры**: "Екатеринбург, Свердловская область, Россия" → "Екатеринбург"
- **Международные**: "Киев, Украина" → "Киев"
- **Fallback**: при ошибке извлечения → "Неизвестный город"

## Пользовательский интерфейс

### Стилизация
- Модальное окно занимает 80% ширины экрана
- Высота 70% от высоты окна
- Карта занимает всю доступную площадь модального окна
- Элементы управления расположены поверх карты
- Информационная панель в нижней части карты

### Адаптивность
- Корректное отображение на мобильных устройствах
- Оптимизированные размеры кнопок для сенсорных экранов
- Правильное позиционирование элементов на разных разрешениях

## Обработка ошибок

### Сценарии ошибок
- Отсутствие подключения к интернету
- Ошибка загрузки API Яндекс.Карт
- Отказ в доступе к геолокации
- Некорректные координаты

### Механизмы защиты
- Проверка доступности API перед инициализацией
- Индикатор загрузки карты
- Сообщения об ошибках с понятными инструкциями
- Fallback к ручному выбору места при ошибке геолокации

## Интеграция с игрой

### Влияние на игровой процесс
- Выбранное место определяет климатические условия
- Влияет на доступные медоносы и сезонность
- Определяет базовые параметры взятка
- Автоматически настраивает экономические условия

### Сохранение настроек
- Местоположение сохраняется вместе с другими настройками игры
- Координаты используются для расчета погодных условий
- Город отображается в интерфейсе игры

## Преимущества реализации

1. **Интуитивность**: Простой и понятный интерфейс выбора места
2. **Точность**: Использование реальных географических данных
3. **Удобство**: Возможность использовать геолокацию
4. **Интеграция**: Полная интеграция с системой настроек игры
5. **Надежность**: Обработка ошибок и fallback механизмы
6. **Производительность**: Динамическая загрузка API только при необходимости

## Файлы изменений

- **templates/settings.html**: добавлена кнопка, модальное окно и JavaScript функциональность
- **CSS стили**: добавлены стили для input-group, модального окна карты и элементов управления
- **JavaScript функции**: полная функциональность для работы с картой

## Тестирование

### Сценарии тестирования
1. Открытие модального окна с картой
2. Клик по карте для выбора места
3. Перетаскивание метки по карте
4. Использование геолокации
5. Поиск места через поиск Яндекс.Карт
6. Подтверждение выбора и закрытие окна
7. Обновление поля города в форме

### Ожидаемые результаты
- Модальное окно открывается корректно
- Карта загружается без ошибок
- Все интерактивные элементы работают
- Город автоматически определяется по выбранному месту
- Настройки сохраняются корректно

---

**Дата реализации**: Текущая версия  
**Статус**: Готово к использованию  
**Совместимость**: Все современные браузеры с поддержкой HTML5 и JavaScript